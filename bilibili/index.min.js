var api_url = "https://www.mxnzp.com/api/bilibili/video";
var code = "";

var app_id = api.id;
var app_secret = api.secret;

function clear_info() {
  document.getElementById("dy_url").value = "";
}

function get_link() {
  var link_after = document.getElementById("dy_url").value;
  if (link_after == "") {
    alert("链接为空！请检查后再提交！");
    console.log("User enteres empty link!");
  } else if (link_after != "") {
    code = "";
    var origin_url = link_after;
    console.log("origin link: " + origin_url);
    var data_url = window.btoa(unescape(encodeURIComponent(origin_url)));
    console.log("base64 link address: " + data_url);
    $.ajax({
      type: "GET",
      url: api_url,
      data: {
        url: data_url,
        app_id: app_id,
        app_secret: app_secret,
      },
      dataType: "json",
      success: function (e) {
        if (e.msg == "视频解析失败") {
          alert("解析失败！请检查视频链接后重新解析！");
          console.warn("Video Load Failed!");
        } else if (e.msg == "数据返回成功！") {
          console.log("Video Load SuccessFully!");
          console.log("Video Title: " + e.data.title);
          console.log("Video Cover Url: " + e.data.cover);
          for (let index = 0; index < e.data.list.length; index++) {
            for (let quality = 0; quality < e.data.list[index].accept.length; quality++) {
              code += `<div class="card card-show">
              <img src="${e.data.cover}" class="card-img-top" alt="...">
              <div class="card-body">
                <h4 class="card-title">标题：${e.data.title}</h4>
                <h5 class="card-title">分片标题：${e.data.list[index].title}</h5>
                <h5 class="card-title">视频简介：${e.data.desc}</h5>
                <p class="card-text">清晰度：${e.data.list[index].accept[quality]}</p>
                <p class="card-text">尺寸：${e.data.list[index].width}x${e.data.list[index].height}</p>
                <p class="card-text">时长：${e.data.list[index].durationFormat}</p>
                <a class="btn btn-primary" href="${e.data.list[index].url}" style="display: block;margin: auto;">下载视频</a>
              </div>
            </div>`;
            }
          }
          $("#card_show").html("");
          document.getElementById("card_show").innerHTML = code;
        } else {
          alert("未知错误！建议检查网络连接后刷新网页！");
          console.log("Unknown Failed!");
        }
      },
    });
  }
}
