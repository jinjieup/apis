window.onload = function () {
  $.ajax({
    url: saying_url,
    success: function (result) {
      $("#saying").text(result);
    },
  });
  get_verify_image();
};

var v_statu = 0;
var app_id = api.id;
var app_secret = api.secret;
var captcha_id = "";

function get_verify_image(){
  var settings = {
    "url": "https://hn216.api.yesapi.cn/api/App/Captcha/Create?app_key=DF2FFBE15C848C37ED338972710EA003&return_data=0&return_format=data",
    "method": "GET",
    "timeout": 0,
  };
  
  $.ajax(settings).done(function (response) {
    var img_url = response.data.captcha_img;
    var code = `<img onclick="get_verify_image()" style="width: 150px;" src="data:image/png;base64,${img_url}" alt="">`;
    document.getElementById("v_img").innerHTML="";
    document.getElementById("v_img").innerHTML=code;
    captcha_id = response.data.captcha_id;
  });
}

function verify(){
  var input_verify = document.getElementById("v_input").value;
  console.log("input verify: ",input_verify);
  var settings = {
    "url": "https://hn216.api.yesapi.cn/api/App/Captcha/Verify?app_key=DF2FFBE15C848C37ED338972710EA003&captcha_id="+captcha_id+"&captcha_code="+input_verify,
    "method": "GET",
    "timeout": 0,
  };
  
  $.ajax(settings).done(function (response) {
    console.log(response);
    console.warn("ret: ",response.ret);
    var statu_code = response.data.err_code;
    if (statu_code == 0) {
      document.getElementById("v_img").innerHTML="";
      document.getElementById("v_img").innerHTML="验证成功！";
      var send_btn_code = `<a class="btn btn-primary" href="#" onclick="v_info_check()" role="button" style="width: 100%;inline-size:-webkit-fill-available;">发送邮件</a>`;
      document.getElementById("verify").innerHTML = "";
      document.getElementById("send_btn").innerHTML = send_btn_code;
      v_statu = 1;
    } else {
      alert(response.data.err_msg);
      get_verify_image();
      document.getElementById("v_input").value = "";
    }
  });
}

function v_info_check(){
  var address = document.getElementById("address").value;
  var title = document.getElementById("title").value;
  var content = document.getElementById("content").value;
  if (v_statu == 0) {
    alert("请输入验证码！");
  } else if (v_statu == 1) {
    if (address == "" || title == "" || content == "") {
      alert("星号为必填项，请检查后再次尝试发送！");
    } else {
      send_mail();
    }
  } else {
    location.reload();
  }
}

function send_mail(){
  var address = document.getElementById("address").value;
  var title = document.getElementById("title").value;
  var content = document.getElementById("content").value;
  var CC = document.getElementById("CC").value;
  var BCC = document.getElementById("BCC").value;
  var email_sender = document.getElementById("email_sender").value;
  $.ajax({
    type: "POST",
    url: "https://hn216.api.yesapi.cn/api/App/Email/Send",
    data: {
      app_key: "DF2FFBE15C848C37ED338972710EA003",
      return_data: 0,
      address: address,
      title: title,
      content: content,
      CC: CC,
      BCC: BCC,
      configuration: "",
      attachments: "",
      email_sender: email_sender,
    },
    dataType: "json",
    success: function (e) {
      if (e.ret == 200) {
        alert("邮件已成功发送！");
        location.reload();
      } else {
        alert("未知错误！请联系客服处理！或稍后再试！错误代码：",e.ret);
      }
    }
  });
}

function clear_info() {
  document.getElementById("address").value = "";
  document.getElementById("title").value = "";
  document.getElementById("content").value = "";
  document.getElementById("CC").value = "";
  document.getElementById("BCC").value = "";
  document.getElementById("email_sender").value = "";
}