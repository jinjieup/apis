window.onload = function () {
  $.ajax({
    url: saying_url,
    success: function (result) {
      $("#saying").text(result);
    },
  });
  get_verify_image();
};

var v_img_code = "";
var v_statu = 0;

function get_verify_image(){
  var settings = {
    "url": "https://hn216.api.yesapi.cn/api/App/Captcha/Create4?app_key=DF2FFBE15C848C37ED338972710EA003&return_data=0&cap_type=1&cap_width=150&cap_height=40",
    "method": "GET",
    "timeout": 0,
  };
  
  $.ajax(settings).done(function (response) {
    var img_url = response.data.img_url
    var code = `<img onclick="get_verify_image()" src="${img_url}" alt="">`
    document.getElementById("v_img").innerHTML="";
    document.getElementById("v_img").innerHTML=code;
    v_img_code = response.data.code;
  });
}

function verify(){
  var input_verify = document.getElementById("v_input").value;
  console.log("input verify: ",input_verify);
  if (input_verify == v_img_code) {
    document.getElementById("v_img").innerHTML="";
    document.getElementById("v_img").innerHTML="验证成功！";
    var send_btn_code = `<a class="btn btn-primary" href="#" onclick="v_info_check()" role="button" style="width: 100%;">发送邮件</a>`;
    document.getElementById("send_btn").innerHTML = send_btn_code;
    v_statu = 1;
  } else {
    get_verify_image();
    document.getElementById("v_input").value = "";
  }
}

function v_info_check(){
  var address = document.getElementById("address").value;
  var title = document.getElementById("title").value;
  var content = document.getElementById("content").value;
  if (v_statu == 0) {
    alert("请输入验证码！");
  } else if (v_statu == 1) {
    if (address == "" || title == "" || content == "") {
      alert("星号为必填项，请检查后再次尝试发送！");
    } else {
      send_mail();
    }
  } else {
    location.reload();
  }
}

function send_mail(){
  var address = document.getElementById("address").value;
  var title = document.getElementById("title").value;
  var content = document.getElementById("content").value;
  var CC = document.getElementById("CC").value;
  var BCC = document.getElementById("BCC").value;
  var email_sender = document.getElementById("email_sender").value;
  $.ajax({
    type: "POST",
    url: "https://hn216.api.yesapi.cn/api/App/Email/Send",
    data: {
      app_key: "DF2FFBE15C848C37ED338972710EA003",
      return_data: 0,
      address: address,
      title: title,
      content: content,
      CC: CC,
      BCC: BCC,
      configuration: "",
      attachments: "",
      email_sender: email_sender,
    },
    dataType: "json",
    success: function (e) {
      if (e.ret == 200) {
        alert("邮件已成功发送！");
        var address = document.getElementById("address").value = "";
        var title = document.getElementById("title").value = "";
        var content = document.getElementById("content").value = "";
        var CC = document.getElementById("CC").value = "";
        var BCC = document.getElementById("BCC").value = "";
        var email_sender = document.getElementById("email_sender").value = "";
      } else {
        alert("未知错误！请联系客服处理！或稍后再试！错误代码：",e.ret);
      }
    }
  });
}