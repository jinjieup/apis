var typeID;
var api_url = "https://www.mxnzp.com/api/news/list";
var id = api.id;
var secret = api.secret;
var news_id_list = {};
var page = 1;

// code代表轮播图
var code = "";
var code_btn = "";
var code_img = "";

window.onload = function () {
  get_id();
  $.ajax({
    url: saying_url,
    success: function (result) {
      $("#saying").text(result);
    },
  });
};

function get_id() {
  typeID = location.search.split("=")[1];
  if (typeID == "" || typeID == "undefined") {
    alert("未查询到有效ID！");
    console.error("No ID founded!");
    window.open("../news/#", "_self");
  } else {
    console.warn("get typeID => " + typeID);
    get_list(typeID);
  }
}

function list_show(t_id, pg_num) {
  $.ajax({
    type: "GET",
    url: api_url,
    data: {
      typeId: t_id,
      page: pg_num,
      app_id: id,
      app_secret: secret,
    },
    dataType: "json",
    success: function (e) {
      if (e.msg == "数据返回成功！") {
        if (e.data.length == 0) {
          alert("此页无数据！");
          console("Empty response!");
        } else {
          code = "";
          code_btn = "";
          code_img = "";
          console.log("List Load SuccessFully!");
          console.log(e);
          for (let index = 0; index < e.data.length; index++) {
            if (e.data[index].imgList == null){
              code += `<div class="col-sm-6">
              <div class="card mb-3">
                <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                  <div class="carousel-indicators">
                  <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" aria-label="Slide 1"></button>
                  </div>
                  <div class="carousel-inner">
                  <div class="carousel-item active">
                  <img src="../images/no_image.jpg" class="d-block w-100" alt="...">
                </div>
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">上一张</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">下一张</span>
                  </button>
                </div>
                <div class="card-body">
                  <h5 class="card-title">${e.data[index].title}</h5>
                  <p class="card-text">${e.data[index].digest}...</p>
                  <a href="#subtitle" onclick="detail(${index})"  type="button" style="float: right;" class="btn btn-primary">了解详情</a>
                  <p class="card-text"><small class="text-muted">由 ${e.data[index].source} 发表于${e.data[index].postTime}</small></p>
                </div>
              </div>
            </div>`;
            } else {
              for (let img_l = 0;img_l < e.data[index].imgList.length;img_l++) {
                if (img_l == 0) {
                  code_img += `<div class="carousel-item active">
                    <img src="${e.data[index].imgList[img_l]}" class="d-block w-100" alt="...">
                  </div>`;
                  code_btn += `<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="${img_l}" class="active" aria-current="true" aria-label="Slide ${
                    img_l + 1
                  }"></button>`;
                } else if (img_l > 0) {
                  code_img += `<div class="carousel-item">
                    <img src="${e.data[index].imgList[img_l]}" class="d-block w-100" alt="...">
                  </div>`;
                  code_btn += `<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="${img_l}" aria-label="Slide ${
                    img_l + 1
                  }"></button>`;
                }
              }
              code +=
                `<div class="col-sm-6">
                <div class="card mb-3">
                  <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                      ` +
                code_btn +
                `
                    </div>
                    <div class="carousel-inner">
                      ` +
                code_img +
                `
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">上一张</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">下一张</span>
                    </button>
                  </div>
                  <div class="card-body">
                    <h5 class="card-title">${e.data[index].title}</h5>
                    <p class="card-text">${e.data[index].digest}...</p>
                    <a href="#subtitle" onclick="detail(${index})"  type="button" style="float: right;" class="btn btn-primary">了解详情</a>
                    <p class="card-text"><small class="text-muted">由 ${e.data[index].source} 发表于${e.data[index].postTime}</small></p>
                  </div>
                </div>
              </div>`;
            }
            news_id_list[index] = e.data[index].newsId;
            code_btn = "";
            code_img = "";
          }
          $("#news_list").html("");
          document.getElementById("news_list").innerHTML = code;
        }
      } else if (e.msg == "请求超时,请稍后再试") {
        alert("请求超时,请稍后再试");
        console.log("Request Timeout!");
      } else {
        alert("未知错误！建议刷新页面后再次尝试！");
        console.warn("Unknown Failed!");
      }
    },
  });
}

function get_list(t_id) {
  $("#change_page_btn").html("");
  document.getElementById("change_page_btn").innerHTML = `<div class="col-6">
  <button class="btn border-primary page-btn" disabled>上一页</button>
  </div>
  <div class="col-6">
  <button onclick="change(1)" class="btn border-primary page-btn">下一页</button>
  </div>`;
  list_show(t_id, page);
}

function btn_list(num) {
  list_show(typeID, num);
}

function detail(news_id_num) {
  var jump_id = news_id_list[news_id_num];
  console.log("User jump to news detail bt id: " + jump_id);
  var jump_url = "../detail/?id=" + jump_id;
  window.open(jump_url, "_blank");
}

function change(e) {
  if (e == 1) {
    page += 1;
    list_show(typeID, page);
    console.log("User click next page btn!");
    $("#change_page_btn").html("");
    document.getElementById("change_page_btn").innerHTML = `<div class="col-6">
        <button onclick="change(0)" class="btn border-primary page-btn">上一页</button>
      </div>
      <div class="col-6">
        <button onclick="change(1)" class="btn border-primary page-btn">下一页</button>
      </div>`;
  } else if (e == 0) {
    page -= 1;
    list_show(typeID, page);
    console.log("User click perious page btn!");
    if (page == 1) {
      $("#change_page_btn").html("");
      document.getElementById("change_page_btn").innerHTML = `<div class="col-6">
          <button class="btn border-primary page-btn" disabled>上一页</button>
        </div>
        <div class="col-6">
          <button onclick="change(1)" class="btn border-primary page-btn">下一页</button>
        </div>`;
    } else if (page > 1) {
      $("#change_page_btn").html("");
      document.getElementById("change_page_btn").innerHTML = `<div class="col-6">
          <button onclick="change(0)" class="btn border-primary page-btn">上一页</button>
        </div>
        <div class="col-6">
          <button onclick="change(1)" class="btn border-primary page-btn">下一页</button>
        </div>`;
    }
  }
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if (new Date().getTime() - start > milliseconds) {
      break;
    }
  }
}
